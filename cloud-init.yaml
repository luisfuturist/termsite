#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io

runcmd:
  # Remove all existing Port directives
  - sed -i '/^Port[[:space:]]/d' /etc/ssh/sshd_config

  # Set SSH port explicitly
  - echo 'Port 2200' >> /etc/ssh/sshd_config

  # Validate before restart
  - sshd -t

  # Restart SSH (use 'ssh' service name on Ubuntu)
  - systemctl restart ssh || systemctl restart sshd

  # Firewall - configure UFW before enabling
  - ufw --force reset
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 2200/tcp comment 'SSH system access'
  - ufw allow 22/tcp comment 'SSH application access'
  - ufw --force enable
  - systemctl enable ufw
  - systemctl start ufw